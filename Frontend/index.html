<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–µ—Ç–µ–æ—Å–∏—Å—Ç–µ–º–∞</title>
  <link rel="stylesheet" href="./main.css" />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ (–ú–ï–¢–ï–û–ë–Æ–õ–õ–ï–¢–ï–ù–¨ / –ñ–£–†–ù–ê–õ –ò–ó–ú–ï–†–ï–ù–ò–ô)
      const tabButtons = document.querySelectorAll('.meteo__nav-btn');
      const tabContents = document.querySelectorAll('.meteo__tab');

      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å active –Ω–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–∫–∞—Ö
          tabButtons.forEach(b => b.classList.remove('meteo__nav-btn--active'));
          // –ù–∞–∑–Ω–∞—á–∞–µ–º active –Ω–∞ —Ç–µ–∫—É—â—É—é
          btn.classList.add('meteo__nav-btn--active');

          const targetTab = btn.getAttribute('data-tab');

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
          tabContents.forEach(tc => {
            if (tc.id === targetTab) {
              tc.classList.remove('meteo__tab--hidden');
            } else {
              tc.classList.add('meteo__tab--hidden');
            }
            });

            const logBody = document.querySelector('.log__body');
            logBody.innerHTML = "";

            fetch(`http://localhost:3000/history?select=data,inputs(height,temperature,pressure,wind_speed,bullet_speed)`)
            .then(response => response.json())
            .then(data => data.forEach(data_row => {
              const row = document.createElement('tr');
              row.className = 'log__row';

              const cellData = document.createElement('td');
              cellData.className = 'log__cell';
              cellData.textContent = data_row['data'];
              row.appendChild(cellData);

              Object.keys(data_row['inputs']).forEach(key => {
                const cell = document.createElement('td');
                cell.className = 'log__cell';
                cell.textContent = data_row['inputs'][key];
                row.appendChild(cell);
              });
              
              logBody.appendChild(row);
            }));
          });
        });

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ (–î–ú–ö / –í–†)
      const modeButtons = document.querySelectorAll('.mode-selector__btn');
      const windSpeedGroup = document.getElementById('windSpeedGroup');
      const bulletDriftGroup = document.getElementById('bulletDriftGroup');
      let currentMode = 'dmk'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –î–ú–ö

      modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          modeButtons.forEach(b => b.classList.remove('mode-selector__btn--active'));
          btn.classList.add('mode-selector__btn--active');
          currentMode = btn.getAttribute('data-mode');

          if (currentMode === 'dmk') {
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º "–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞"
            windSpeedGroup.style.display = 'flex';
            // –°–∫—Ä—ã–≤–∞–µ–º "–î–∞–ª—å–Ω–æ—Å—Ç—å —Å–Ω–æ—Å–∞ –ø—É–ª—å"
            bulletDriftGroup.style.display = 'none';
          } else {
            // –°–∫—Ä—ã–≤–∞–µ–º "–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞"
            windSpeedGroup.style.display = 'none';
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º "–î–∞–ª—å–Ω–æ—Å—Ç—å —Å–Ω–æ—Å–∞ –ø—É–ª—å"
            bulletDriftGroup.style.display = 'flex';
          }

          checkFormValidity();
        });
      });

      // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
      const inputs = document.querySelectorAll('.input-form__field');
      const createBtn = document.getElementById('createMeteo11');

      inputs.forEach(input => {
        input.addEventListener('input', checkFormValidity);
      });

      function checkFormValidity() {
        let allValid = true;

        inputs.forEach(input => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∏–Ω–ø—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏–º—ã (–Ω–µ —Å–∫—Ä—ã—Ç—ã —á–µ—Ä–µ–∑ display: none)
          if (input.parentElement.style.display !== 'none') {
            if (input.value.trim() === '') {
              allValid = false;
            }
            
            const value = parseFloat(input.value);
          }
        });

        createBtn.disabled = !allValid;
      }

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã "–ú–ï–¢–ï–û-11 –ü–†–ò–ë–õ–ò–ñ–ï–ù–ù–´–ô" –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å –∫–∞–∫ –î–µ–π—Å—Ç–≤."
      const tableNearest = document.getElementById('nearest');
      const tableTruest = document.getElementById('truest');
      const acceptBtn = document.getElementById('acceptBtn');

      createBtn.addEventListener('click', () => {

        const tableBodyNearest = tableNearest.querySelector('.meteo-table__body');
        console.log(tableNearest);
        console.log(tableBodyNearest);
        tableBodyNearest.innerHTML = "";

        const data = {
          'height':document.getElementById('height').value,
          'temperature':document.getElementById('temperature').value,
          'pressure':document.getElementById('pressure').value,
          'windDirection':document.getElementById('windDirection').value,
          'bulletData':currentMode === 'dmk' ? 
            document.getElementById('windSpeed').value : 
            document.getElementById('bulletDrift').value,
          'device_id': currentMode === 'dmk' ? 'b07940a1-c522-4b9c-90ba-771c6869d2d7' : 'c7237b8d-8b89-46ed-a774-f0c7f4ff7e32'
        };

        const input_id = crypto.randomUUID();
        const history_id = crypto.randomUUID();

        fetch('http://localhost:3000/inputs', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: `id=${input_id}&height=${data["height"]}&temperature=${data["temperature"]}&pressure=${data["pressure"]}&wind_speed=${data["bulletData"]}&wind_direction=${data["windDirection"]}&bullet_speed=${data["bulletData"]}`
            })
            .then(() => {
            fetch('http://localhost:3000/history', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                  },
                  body: `id=${history_id}&input_id=${input_id}&logitude=${(Math.random()*100).toFixed(2)}&latitude=${(Math.random()*100).toFixed(2)}&device_id=${data["device_id"]}`
                })
                .then(() => {
                    fetch(`http://localhost:3000/history?id=eq.${history_id}&select=calculation`)
                    .then(response => response.json())
                    .then(data => {
                      console.log(data);
                      const headers = tableNearest.querySelectorAll(".result-panel__date");
                      console.log(headers);
                      headers[0].innerHTML = data[0]['calculation']['header']["datetime"];
                      headers[1].innerHTML = data[0]['calculation']['header']["height"];
                      headers[2].innerHTML = data[0]['calculation']['header']["pressure_temperature"];

                      data[0]['calculation']['calculations']['heights']
                      for (let i = 0; i < data[0]['calculation']['calculations']['heights'].length; i++) {
                        const row = document.createElement('tr');
                        row.className = 'meteo-table__row';

                        const cellHeights = document.createElement('td');
                        cellHeights.className = 'meteo-table__cell';
                        cellHeights.textContent = data[0]['calculation']['calculations']["heights"][i];
                        row.appendChild(cellHeights);

                        const cellWindTemp = document.createElement('td');
                        cellWindTemp.className = 'meteo-table__cell';
                        cellWindTemp.textContent = data[0]['calculation']['calculations']["windtemp"][i];
                        row.appendChild(cellWindTemp);

                        const cellWind = document.createElement('td');
                        cellWind.className = 'meteo-table__cell';
                        cellWind.textContent = data[0]['calculation']['calculations']["wind"][i];
                        row.appendChild(cellWind);

                        const cellBuller = document.createElement('td');
                        cellBuller.className = 'meteo-table__cell';
                        cellBuller.textContent = data[0]['calculation']['calculations']["bullet"][i];
                        row.appendChild(cellBuller);

                        tableBodyNearest.appendChild(row);
                      }
                    });
                })
              });
        
        console.log(history_id);
        console.log(input_id);


        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–Ω—è—Ç—å –∫–∞–∫ –î–µ–π—Å—Ç–≤."
        acceptBtn.classList.remove('meteo-btn--hidden');
      });

      acceptBtn.addEventListener('click', () => {
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π
        tableTruest.querySelector('.result-panel__dates').innerHTML = tableNearest.querySelector('.result-panel__dates').innerHTML;
        tableTruest.querySelector('.meteo-table__body').innerHTML = tableNearest.querySelector('.meteo-table__body').innerHTML;
      });
    });


  </script>
</head>
<body>
  <div class="meteo">
    <nav class="meteo__nav">
      <button class="meteo__nav-btn meteo__nav-btn--active" data-tab="meteo-bulletin">–ú–ï–¢–ï–û–ë–Æ–õ–õ–ï–¢–ï–ù–¨</button>
      <button class="meteo__nav-btn" data-tab="measurement-log">–ñ–£–†–ù–ê–õ –ò–ó–ú–ï–†–ï–ù–ò–ô</button>
    </nav>

    <div class="meteo__tab" id="meteo-bulletin">
      <div class="meteo__content">
        <!-- Left Panel -->
        <div class="input-panel">
          <div class="input-panel__header">
            <div class="mode-selector">
              <button class="mode-selector__btn mode-selector__btn--active" data-mode="dmk">–î–ú–ö</button>
              <button class="mode-selector__btn" data-mode="vr">–í–†</button>
            </div>
          </div>

          <div class="input-form">
            <div class="input-form__group">
              <label class="input-form__label" for="height">–í—ã—Å–æ—Ç–∞ –º–µ—Ç–µ–æ–ø–æ—Å—Ç–∞</label>
              <input class="input-form__field" type="number" id="height" name="height" step="1" value="100">
            </div>
            <div class="input-form__group">
              <label class="input-form__label" for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
              <input class="input-form__field" type="number" id="temperature" name="temperature" step="0.1" value="15">
            </div>
            <div class="input-form__group">
              <label class="input-form__label" for="pressure">–î–∞–≤–ª–µ–Ω–∏–µ</label>
              <input class="input-form__field" type="number" id="pressure" name="pressure" step="1" value="750">
            </div>
            <div class="input-form__group">
              <label class="input-form__label" for="windDirection">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞</label>
              <input class="input-form__field" type="number" id="windDirection" name="windDirection" step="1" value="0">
            </div>
            <div class="input-form__group" id="windSpeedGroup">
              <label class="input-form__label" for="windSpeed">–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞</label>
              <input class="input-form__field" type="number" id="windSpeed" name="windSpeed" step="1" value="0">
            </div>
            <div class="input-form__group" id="bulletDriftGroup" style="display: none;">
              <label class="input-form__label" for="bulletDrift">–î–∞–ª—å–Ω–æ—Å—Ç—å —Å–Ω–æ—Å–∞ –ø—É–ª—å</label>
              <input class="input-form__field" type="number" id="bulletDrift" name="bulletDrift" step="1" value="0">
            </div>
          </div>

          <button class="meteo-btn meteo-btn--primary" id="createMeteo11">–°–û–°–¢–ê–í–ò–¢–¨ –ú–ï–¢–ï–û-11</button>
          <button class="meteo-btn meteo-btn--red" id="acceptBtn">–ü–†–ò–ù–Ø–¢–¨ –ö–ê–ö –î–ï–ô–°–¢–í.</button>
        </div>

        <!-- Right Panel - –ú–ï–¢–ï–û-11 –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π -->
        <div class="result-panel" id="nearest">
          <div class="result-panel__header">
            <div class="result-panel__title">
              –ú–ï–¢–ï–û-11 <span class="result-panel__subtitle">–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–π</span>
            </div>
          </div>

          <div class="result-panel__dates">
            <div class="result-panel__date"></div>
            <div class="result-panel__date"></div>
            <div class="result-panel__date"></div>
          </div>

          <div class="result-panel__header">
            <div class="result-panel__dt-list">
              <div class="result-panel__dt">ŒîT</div>
              <div class="result-panel__dt">ùõÇW</div>
              <div class="result-panel__dt">W</div>
            </div>
          </div>

          <div class="meteo-table">
            <table class="meteo-table__content">
              <tbody class="meteo-table__body">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right Panel - –ú–ï–¢–ï–û-11 -->
        <div class="result-panel" id="truest">
          <div class="result-panel__header">
            <div class="result-panel__title">–ú–ï–¢–ï–û-11</div>
          </div>

          <div class="result-panel__dates">
            <div class="result-panel__date"></div>
            <div class="result-panel__date"></div>
            <div class="result-panel__date"></div>
          </div>

          <div class="result-panel__header">
            <div class="result-panel__dt-list">
              <div class="result-panel__dt">ŒîT</div>
              <div class="result-panel__dt">ùõÇW</div>
              <div class="result-panel__dt">W</div>
            </div>
          </div>

          <div class="meteo-table">
            <table class="meteo-table__content">
              <tbody class="meteo-table__body">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- –ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π tab -->
    <div class="meteo__tab meteo__tab--hidden" id="measurement-log">
      <h2 class="meteo__heading">–ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π</h2>
      <div class="log">
        <table class="log__table">
          <thead class="log__header">
            <tr class="log__row">
              <th class="log__cell log__cell--header">–î–∞—Ç–∞</th>
              <th class="log__cell log__cell--header">–í—ã—Å–æ—Ç–∞</th>
              <th class="log__cell log__cell--header">–¢–µ–º–ø.</th>
              <th class="log__cell log__cell--header">–î–∞–≤–ª.</th>
              <th class="log__cell log__cell--header">–ù–∞–ø—Ä. –≤–µ—Ç—Ä–∞</th>
              <th class="log__cell log__cell--header">–°–∫–æ—Ä–æ—Å—Ç—å/–î–∞–ª—å–Ω–æ—Å—Ç—å</th>
            </tr>
          </thead>
          <tbody class="log__body">
            <!-- Dynamic content -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
